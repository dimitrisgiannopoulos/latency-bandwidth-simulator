<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bouncing Ball Game</title>
    <style>
        canvas {
            border: 1px solid black;
            display: block;
            margin: auto;
        }
        #startGame {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16px;
        }
        #controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        #leftButton, #rightButton {
            padding: 10px 20px;
            font-size: 16px;
        }
        #rtt {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <button id="startGame">Start Game</button>
    <canvas id="gameCanvas" width="500" height="500"></canvas>
    <div id="rtt">Latency: - ms</div>
    <canvas id="latencyGraph" width="500" height="150" style="border: 1px solid black;"></canvas>
    <canvas id="bandwidthGraph" width="500" height="150" style="border: 1px solid black;"></canvas>
    <div id="controls">
        <button id="leftButton">Left</button>
        <button id="rightButton">Right</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startGame');
        let ws = null;
        let gameState = {
            ball: { x: 250, y: 250 },
            paddle: { x: 200, width: 100 },
            score: 0,
            gameOver: false,
        };
    
        // Establish WebSocket connection
        function connectWebSocket() {
            if (ws) ws.close(); // Close any existing WebSocket connection
    
            ws = new WebSocket('ws://localhost:3000');
    
            ws.onopen = () => {
                console.log('WebSocket connection established.');
            };
    
            let paddleX = 200; // Local paddle position

            function movePaddleLeft() {
                paddleX = Math.max(0, paddleX - 10); // Ensure paddle doesn't move out of bounds
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'paddleMove', paddleX }));
                }
            }

            function movePaddleRight() {
                paddleX = Math.min(400, paddleX + 10); // Ensure paddle doesn't move out of bounds
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'paddleMove', paddleX }));
                }
            }

            // Attach keyboard and button event listeners
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') movePaddleLeft();
                if (e.key === 'ArrowRight') movePaddleRight();
            });

            document.getElementById('leftButton').addEventListener('mousedown', movePaddleLeft);
            document.getElementById('rightButton').addEventListener('mousedown', movePaddleRight);

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'gameState') {
                    gameState = data.gameState;
                    paddleX = gameState.paddle.x; // Sync paddle position with server
                } else if (data.type === 'gameOver') {
                    alert(`Game Over! Your score: ${data.score}`);
                    ws.close(); // Close WebSocket after game over
                }
            };
    
            ws.onclose = () => {
                console.log('WebSocket connection closed.');
            };
    
            ws.onerror = (err) => {
                console.error('WebSocket error:', err);
            };
        }
    
        // Start the game
        startButton.addEventListener('click', () => {
            console.log('Start button clicked.');
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                connectWebSocket();
            }
    
            setTimeout(() => {
                // Send startGame request to server
                if (ws.readyState === WebSocket.OPEN) {
                    console.log('Sending startGame request to server.');
                    ws.send(JSON.stringify({ type: 'startGame' }));
                } else {
                    console.error('WebSocket is not ready.');
                }
            }, 500);
        });
    
        // Render the game
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
    
            // Draw the ball
            ctx.beginPath();
            ctx.arc(gameState.ball.x, gameState.ball.y, 10, 0, Math.PI * 2);
            ctx.fillStyle = 'blue';
            ctx.fill();
            ctx.closePath();
    
            // Draw the paddle
            ctx.fillStyle = 'black';
            ctx.fillRect(gameState.paddle.x, 480, gameState.paddle.width, 10);
    
            // Draw the score
            ctx.font = '16px Arial';
            ctx.fillText(`Score: ${gameState.score}`, 10, 20);
    
            requestAnimationFrame(render);
        }
    
        render();
    </script>    
</body>
</html>
